<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨ç›‘æ§ç³»ç»Ÿ - Google Sheetsç‰ˆ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const TrendingUp = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const TrendingDown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const RefreshCw = ({ className }) => <svg className={className} width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
        const Plus = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const Check = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const Bell = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>;
        const Database = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;

        const StockMonitor = () => {
          const [stocks, setStocks] = useState([]);
          const [loading, setLoading] = useState(false);
          const [newStock, setNewStock] = useState({ symbol: '', market: 'US', targetPrice: '' });
          const [sheetUrl, setSheetUrl] = useState('');
          const [isConnected, setIsConnected] = useState(false);
          const [lastUpdate, setLastUpdate] = useState(null);

          const marketConfig = {
            'US': { name: 'ç¾è‚¡', currency: '$', symbol: 'USD' },
            'JP': { name: 'æ—¥è‚¡', currency: 'Â¥', symbol: 'JPY' },
            'CN': { name: 'Aè‚¡', currency: 'Â¥', symbol: 'CNY', optional: true },
            'HK': { name: 'æ¸¯è‚¡', currency: 'HK$', symbol: 'HKD', optional: true }
          };

          const loadFromSheets = async () => {
            if (!sheetUrl) {
              alert('è¯·å…ˆè¾“å…¥Google Sheetsé“¾æ¥');
              return;
            }
            
            setLoading(true);
            try {
              const csvUrl = sheetUrl.includes('/edit') 
                ? sheetUrl.replace('/edit#gid=', '/export?format=csv&gid=').replace('/edit', '/export?format=csv')
                : sheetUrl;
              
              const response = await fetch(csvUrl);
              const text = await response.text();
              
              const rows = text.split('\n').slice(1);
              const parsedStocks = rows
                .filter(row => row.trim())
                .map((row, index) => {
                  const [symbol, name, market, targetPrice, currentPrice, status] = row.split(',');
                  return {
                    id: index,
                    symbol: symbol?.trim() || '',
                    name: name?.trim() || '',
                    market: market?.trim() || 'US',
                    targetPrice: parseFloat(targetPrice) || 0,
                    currentPrice: parseFloat(currentPrice) || 0,
                    status: status?.trim() || 'monitoring'
                  };
                })
                .filter(stock => stock.symbol);
              
              setStocks(parsedStocks);
              setIsConnected(true);
              setLastUpdate(new Date());
              alert('âœ“ æˆåŠŸä»Google SheetsåŠ è½½æ•°æ®ï¼');
            } catch (error) {
              console.error('åŠ è½½å¤±è´¥:', error);
              alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ï¼š\n1. Google Sheetså·²å‘å¸ƒåˆ°ç½‘ç»œ\n2. å‘å¸ƒæ ¼å¼é€‰æ‹©CSV\n3. é“¾æ¥æ ¼å¼æ­£ç¡®');
            }
            setLoading(false);
          };

          const fetchStockPrice = async (symbol, market) => {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            switch(market) {
              case 'US': return Math.random() * 300 + 50;
              case 'JP': return Math.random() * 3000 + 1000;
              case 'CN': return Math.random() * 100 + 10;
              case 'HK': return Math.random() * 500 + 50;
              default: return Math.random() * 100 + 50;
            }
          };

          const refreshPrices = async () => {
            setLoading(true);
            const updatedStocks = await Promise.all(
              stocks.map(async (stock) => {
                const currentPrice = await fetchStockPrice(stock.symbol, stock.market);
                const isTarget = currentPrice >= stock.targetPrice;
                
                if (isTarget && stock.status !== 'target_reached') {
                  sendNotification(stock.symbol, currentPrice, stock.targetPrice, stock.market);
                }
                
                return {
                  ...stock,
                  currentPrice,
                  status: isTarget ? 'target_reached' : 'monitoring'
                };
              })
            );
            
            setStocks(updatedStocks);
            setLastUpdate(new Date());
            setLoading(false);
          };

          const sendNotification = (symbol, currentPrice, targetPrice, market) => {
            if ('Notification' in window && Notification.permission === 'granted') {
              const currency = marketConfig[market].currency;
              new Notification('ğŸ¯ ç›®æ ‡ä»·æ ¼å·²è¾¾åˆ°ï¼', {
                body: `${symbol} å½“å‰ä»·æ ¼ ${currency}${currentPrice.toFixed(2)} å·²è¾¾åˆ°ç›®æ ‡ä»·æ ¼ ${currency}${targetPrice.toFixed(2)}`
              });
            }
          };

          const requestNotificationPermission = () => {
            if ('Notification' in window && Notification.permission === 'default') {
              Notification.requestPermission();
            }
          };

          const addStock = () => {
            if (!newStock.symbol || !newStock.targetPrice) {
              alert('è¯·å¡«å†™è‚¡ç¥¨ä»£ç å’Œç›®æ ‡ä»·æ ¼');
              return;
            }

            const stock = {
              id: Date.now(),
              symbol: newStock.symbol.toUpperCase(),
              name: newStock.symbol.toUpperCase(),
              market: newStock.market,
              targetPrice: parseFloat(newStock.targetPrice),
              currentPrice: 0,
              status: 'monitoring'
            };

            setStocks([...stocks, stock]);
            setNewStock({ symbol: '', market: 'US', targetPrice: '' });
          };

          const deleteStock = (id) => {
            setStocks(stocks.filter(stock => stock.id !== id));
          };

          const formatPrice = (price, market) => {
            const config = marketConfig[market] || marketConfig['US'];
            return `${config.currency}${price.toFixed(2)}`;
          };

          useEffect(() => {
            requestNotificationPermission();
            
            const interval = setInterval(() => {
              if (stocks.length > 0 && isConnected) {
                refreshPrices();
              }
            }, 300000);

            return () => clearInterval(interval);
          }, [stocks, isConnected]);

          const getStatusColor = (status) => {
            return status === 'target_reached' ? 'bg-green-100 border-green-500' : 'bg-white border-gray-200';
          };

          const getStatusIcon = (status) => {
            return status === 'target_reached' ? <div className="text-green-600"><Check /></div> : null;
          };

          const getMarketBadgeColor = (market) => {
            const colors = {
              'US': 'bg-blue-100 text-blue-800',
              'JP': 'bg-red-100 text-red-800',
              'CN': 'bg-yellow-100 text-yellow-800',
              'HK': 'bg-purple-100 text-purple-800'
            };
            return colors[market] || 'bg-gray-100 text-gray-800';
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="text-center mb-8 pt-8">
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">ğŸ“Š è‚¡ç¥¨ç›‘æ§ç³»ç»Ÿ</h1>
                  <p className="text-gray-600">Google Sheetsç‰ˆ - ç¾è‚¡Â·æ—¥è‚¡ä¸ºä¸»ï¼ŒAè‚¡Â·æ¸¯è‚¡å¯é€‰</p>
                  <div className="flex items-center justify-center gap-2 mt-2">
                    <Database className="text-blue-600" />
                    <span className="text-sm text-blue-600">æ•°æ®å­˜å‚¨åœ¨Google Sheets</span>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                    <TrendingUp />
                    è¿æ¥Google Sheets
                  </h2>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      placeholder="ç²˜è´´Google Sheetsçš„CSVå¯¼å‡ºé“¾æ¥..."
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={sheetUrl}
                      onChange={(e) => setSheetUrl(e.target.value)}
                    />
                    <button
                      onClick={loadFromSheets}
                      disabled={loading}
                      className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2"
                    >
                      <RefreshCw className={loading ? 'animate-spin' : ''} />
                      åŠ è½½æ•°æ®
                    </button>
                  </div>
                  {isConnected && (
                    <p className="text-sm text-green-600 mt-2">âœ“ å·²è¿æ¥åˆ°Google Sheets</p>
                  )}
                  <details className="mt-4">
                    <summary className="text-sm text-gray-600 cursor-pointer hover:text-gray-800">
                      å¦‚ä½•è®¾ç½®Google Sheetsï¼Ÿç‚¹å‡»æŸ¥çœ‹
                    </summary>
                    <div className="mt-2 text-sm text-gray-600 bg-gray-50 p-4 rounded space-y-2">
                      <p><strong>æ­¥éª¤1ï¼š</strong>åœ¨Google Sheetsä¸­åˆ›å»ºè¡¨æ ¼</p>
                      <p><strong>åˆ—æ ‡é¢˜ï¼š</strong>è‚¡ç¥¨ä»£ç  | åç§° | å¸‚åœº | ç›®æ ‡ä»·æ ¼ | å½“å‰ä»·æ ¼ | çŠ¶æ€</p>
                      <p><strong>æ­¥éª¤2ï¼š</strong>æ–‡ä»¶ â†’ å…±äº« â†’ å‘å¸ƒåˆ°ç½‘ç»œ</p>
                      <p><strong>æ­¥éª¤3ï¼š</strong>é€‰æ‹©"æ•´ä¸ªæ–‡æ¡£" + "CSVæ ¼å¼"</p>
                      <p><strong>æ­¥éª¤4ï¼š</strong>ç‚¹å‡»"å‘å¸ƒ"å¹¶å¤åˆ¶é“¾æ¥</p>
                      <div className="mt-3 p-3 bg-blue-50 rounded">
                        <p className="font-semibold text-blue-800">âœ… æ¨èå¸‚åœºï¼šUSï¼ˆç¾è‚¡ï¼‰ã€JPï¼ˆæ—¥è‚¡ï¼‰</p>
                        <p className="text-blue-700 text-xs mt-1">CNï¼ˆAè‚¡ï¼‰å’ŒHKï¼ˆæ¸¯è‚¡ï¼‰æ•°æ®å¯èƒ½ä¸ç¨³å®š</p>
                      </div>
                    </div>
                  </details>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                    <Plus />
                    æ·»åŠ ç›‘æ§è‚¡ç¥¨
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input
                      type="text"
                      placeholder="è‚¡ç¥¨ä»£ç  (å¦‚: AAPL)"
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={newStock.symbol}
                      onChange={(e) => setNewStock({...newStock, symbol: e.target.value.toUpperCase()})}
                    />
                    <select
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={newStock.market}
                      onChange={(e) => setNewStock({...newStock, market: e.target.value})}
                    >
                      <option value="US">âœ… ç¾è‚¡ (USD $)</option>
                      <option value="JP">âœ… æ—¥è‚¡ (JPY Â¥)</option>
                      <option value="CN">âš ï¸ Aè‚¡ (CNY Â¥) - å¯é€‰</option>
                      <option value="HK">âš ï¸ æ¸¯è‚¡ (HKD HK$) - å¯é€‰</option>
                    </select>
                    <input
                      type="number"
                      placeholder="ç›®æ ‡ä»·æ ¼"
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={newStock.targetPrice}
                      onChange={(e) => setNewStock({...newStock, targetPrice: e.target.value})}
                    />
                    <button
                      onClick={addStock}
                      className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
                    >
                      <Plus />
                      æ·»åŠ 
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <div className="flex justify-between items-center">
                    <div>
                      <h2 className="text-xl font-semibold flex items-center gap-2">
                        <Bell />
                        ç›‘æ§æ¸…å•
                        <span className="text-sm font-normal text-gray-500">
                          ({stocks.length} åªè‚¡ç¥¨)
                        </span>
                      </h2>
                      {lastUpdate && (
                        <p className="text-sm text-gray-500 mt-1">
                          æœ€åæ›´æ–°: {lastUpdate.toLocaleTimeString('zh-CN')}
                        </p>
                      )}
                    </div>
                    <button
                      onClick={refreshPrices}
                      disabled={loading || stocks.length === 0}
                      className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2"
                    >
                      <RefreshCw className={loading ? 'animate-spin' : ''} />
                      åˆ·æ–°ä»·æ ¼
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {stocks.map((stock) => {
                    const priceChange = stock.currentPrice - stock.targetPrice;
                    const changePercent = stock.targetPrice > 0 
                      ? ((priceChange / stock.targetPrice) * 100).toFixed(2)
                      : 0;
                    const isUp = priceChange >= 0;
                    const marketInfo = marketConfig[stock.market] || marketConfig['US'];

                    return (
                      <div
                        key={stock.id}
                        className={`rounded-lg shadow-lg p-6 border-2 ${getStatusColor(stock.status)} transition-all`}
                      >
                        <div className="flex justify-between items-start mb-4">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <h3 className="text-2xl font-bold text-gray-800">{stock.symbol}</h3>
                              {getStatusIcon(stock.status)}
                            </div>
                            <div className="flex items-center gap-2">
                              <span className={`text-xs px-2 py-1 rounded-full font-semibold ${getMarketBadgeColor(stock.market)}`}>
                                {marketInfo.name}
                              </span>
                              <span className="text-sm text-gray-600">{stock.name}</span>
                            </div>
                          </div>
                          <button
                            onClick={() => deleteStock(stock.id)}
                            className="text-red-500 hover:text-red-700 p-1"
                          >
                            <Trash2 />
                          </button>
                        </div>

                        <div className="space-y-3">
                          <div>
                            <p className="text-sm text-gray-600">å½“å‰ä»·æ ¼</p>
                            <p className="text-3xl font-bold text-gray-800">
                              {stock.currentPrice > 0 ? formatPrice(stock.currentPrice, stock.market) : '--'}
                            </p>
                          </div>

                          <div>
                            <p className="text-sm text-gray-600">ç›®æ ‡ä»·æ ¼</p>
                            <p className="text-xl font-semibold text-gray-700">
                              {formatPrice(stock.targetPrice, stock.market)}
                            </p>
                          </div>

                          {stock.currentPrice > 0 && (
                            <div className={`flex items-center gap-2 ${isUp ? 'text-green-600' : 'text-red-600'}`}>
                              {isUp ? <TrendingUp /> : <TrendingDown />}
                              <span className="font-semibold">
                                {isUp ? '+' : ''}{marketInfo.currency}{Math.abs(priceChange).toFixed(2)} ({isUp ? '+' : ''}{changePercent}%)
                              </span>
                            </div>
                          )}

                          {stock.status === 'target_reached' && (
                            <div className="bg-green-50 border border-green-200 rounded p-2 mt-2">
                              <p className="text-sm text-green-700 font-semibold">
                                ğŸ¯ å·²è¾¾åˆ°ç›®æ ‡ä»·æ ¼ï¼
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {stocks.length === 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                    <p className="text-gray-500 text-lg mb-6">
                      æš‚æ— ç›‘æ§è‚¡ç¥¨ï¼Œè¯·ä»Google SheetsåŠ è½½æˆ–æ‰‹åŠ¨æ·»åŠ 
                    </p>
                    <div className="grid grid-cols-2 gap-4 max-w-md mx-auto">
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <p className="font-semibold text-blue-800">âœ… ç¾è‚¡</p>
                        <p className="text-sm text-gray-600 mt-1">AAPL, GOOGL</p>
                        <p className="text-xs text-blue-600 mt-1">æ•°æ®å‡†ç¡®</p>
                      </div>
                      <div className="bg-red-50 p-4 rounded-lg">
                        <p className="font-semibold text-red-800">âœ… æ—¥è‚¡</p>
                        <p className="text-sm text-gray-600 mt-1">7203.T, 6758.T</p>
                        <p className="text-xs text-red-600 mt-1">æ•°æ®å¯é </p>
                      </div>
                    </div>
                  </div>
                )}

                <div className="mt-8 bg-white rounded-lg shadow p-6 text-center text-sm text-gray-600 mb-8">
                  <h3 className="font-semibold text-gray-800 mb-3">ğŸ’¡ æ–¹æ¡ˆç‰¹ç‚¹</h3>
                  <div className="grid md:grid-cols-2 gap-4 text-left">
                    <div>
                      <p className="font-semibold text-green-700 mb-2">âœ… æ ¸å¿ƒä¼˜åŠ¿</p>
                      <ul className="space-y-1 text-xs">
                        <li>â€¢ ç¾è‚¡ã€æ—¥è‚¡æ•°æ®å‡†ç¡®å¯é </li>
                        <li>â€¢ é…åˆApps Script 24/7è‡ªåŠ¨ç›‘æ§</li>
                        <li>â€¢ é‚®ä»¶é€šçŸ¥ä¸ä¼šé”™è¿‡</li>
                        <li>â€¢ æ•°æ®å®‰å…¨å­˜å‚¨åœ¨Googleäº‘ç«¯</li>
                      </ul>
                    </div>
                    <div>
                      <p className="font-semibold text-yellow-700 mb-2">âš ï¸ æ³¨æ„äº‹é¡¹</p>
                      <ul className="space-y-1 text-xs">
                        <li>â€¢ Aè‚¡æ•°æ®é€šè¿‡GOOGLEFINANCEå¯èƒ½ä¸ç¨³å®š</li>
                        <li>â€¢ æ¸¯è‚¡æ•°æ®æ›´æ–°å¯èƒ½æœ‰å»¶è¿Ÿ</li>
                        <li>â€¢ å»ºè®®ä¸»è¦ç”¨äºç¾è‚¡å’Œæ—¥è‚¡</li>
                        <li>â€¢ Aè‚¡å’Œæ¸¯è‚¡ä½œä¸ºå¯é€‰è¡¥å……</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<StockMonitor />, document.getElementById('root'));
    </script>
</body>
</html>
